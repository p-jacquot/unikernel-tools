#! /bin/bash

# This script download, and compile bots benchmarks for a given unikernel.

unikernel=$1
base_dir=$2

label=$label
ompc=
cc=
omplink=
clink=

case $1 in
    "hermitcore")
        echo "HermitCore selected"
        label="hermit-gcc"
        ompc="$base_dir/bin/x86_64-hermit-gcc -fopenmp"
        cc="$base_dir/bin/x86_64-hermit-gcc"
        omplink="$base_dir/bin/x86_64-hermit-gcc -fopenmp"
        clink="$base_dir/bin/x86_64-hermit-gcc"
        ;;

    "hermitux")
        echo "Hermitux selected"
        label="clang"
        ompc="clang-11 -fopenmp"
        cc="clang-11"
        omplink="$base_dir/musl/obj/musl-gcc -static -liomp5 -L$base_dir/libiomp/build/runtime/src -fopenmp"
        clink="$base_dir/musl/obj/musl-gcc -static"
        ;;

    *)
        echo "Unknown unikernel $unikernel, aborting script."
        exit
        ;;
esac

git clone https://github.com/p-jacquot/bots
cd ./bots

mkdir bin

echo -e "
#Automatically generated by unikernel-tools/benchs/install-bots.sh
#compilers and linkers

#config name
LABEL=$label

ENABLE_OMPSS=

#compilers
OMPSSC=
OMPC=$ompc
CC=$cc
OMPSSLINK=
OMPLINK=$omplink
CLINK=$clink

#compiler and linker flags

OPT_FLAGS=-O3

CC_FLAGS=
OMPC_FLAGS=
OMPSSC_FLAGS=
OMPC_FINAL_FLAGS=
OMPSSC_FINAL_FLAG=

CLINK_FLAGS=
OMPLINK_FLAGS=
OMPSSLINK_FLAGS=" > config/make.config

make
